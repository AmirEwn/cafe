<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منوی دیجیتال لوکس | کافه رستوران</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --secondary: #10b981;
            --dark-bg: #1a202c;
            --light-bg: #f8fafc;
            --dark-text: #1e293b;
            --light-text: #f8fafc;
        }
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            background-color: var(--dark-bg);
            color: var(--light-text);
            transition: all 0.5s ease;
        }
        
        body.light-mode {
            background-color: var(--light-bg);
            color: var(--dark-text);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .light-mode .glass-card {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        .menu-item {
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
        }
        
        .menu-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .light-mode .menu-item:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .category-btn {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .light-mode .category-btn {
            background: rgba(255,255,255,0.7);
        }
        
        .category-btn.active {
            background: linear-gradient(45deg, rgba(245,158,11,0.8), rgba(239,68,68,0.6));
            color: white;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }
        
        .popular-badge {
            background: linear-gradient(45deg, var(--primary), #ef4444);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .price-tag {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .add-to-cart {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            transition: all 0.3s ease;
        }
        
        .add-to-cart:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }
        
        /* استایل‌های سبد خرید */
        .cart-icon {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .cart-icon:hover {
            transform: scale(1.1);
        }
        
        .cart-icon i {
            font-size: 24px;
            color: var(--primary);
        }
        
        .cart-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .cart-panel {
            position: fixed;
            top: 0;
            left: -450px;
            width: 450px;
            height: 100vh;
            background: var(--dark-bg);
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: -5px 0 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .light-mode .cart-panel {
            background: var(--light-bg);
            box-shadow: -5px 0 30px rgba(0,0,0,0.1);
        }
        
        .cart-panel.open {
            left: 0;
        }
        
        .cart-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .light-mode .cart-header {
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .cart-header h3 {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }
        
        .close-cart {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cart-item {
            display: flex;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .light-mode .cart-item {
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .cart-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .cart-item-img {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            margin-left: 15px;
        }
        
        .cart-item-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .cart-item-details {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .cart-item-price {
            color: var(--primary);
            font-weight: 700;
        }
        
        .cart-item-actions {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 30px;
            padding: 2px;
        }
        
        .light-mode .quantity-control {
            background: rgba(0,0,0,0.05);
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }
        
        .quantity-input {
            width: 40px;
            text-align: center;
            background: transparent;
            border: none;
            color: inherit;
            font-weight: 600;
        }
        
        .remove-item {
            margin-right: 15px;
            color: #ef4444;
            cursor: pointer;
            font-size: 18px;
        }
        
        .cart-footer {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .light-mode .cart-footer {
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 18px;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }
        
        .empty-cart {
            text-align: center;
            padding: 40px 0;
            color: #9ca3af;
        }
        
        .empty-cart i {
            font-size: 50px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .cart-panel {
                width: 90%;
                left: -100%;
            }
            
            .cart-panel.open {
                left: 0;
            }
        }
        
        /* بهبود خوانایی متن */
        .light-mode .text-muted {
            color: #4b5563 !important;
        }
        
        .dark-mode .text-muted {
            color: #d1d5db !important;
        }
        
        /* اسکرول بار سفارشی */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        .light-mode ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
        }

        /* لودر */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* استایل‌های جدید برای مدال کامنت */
        #commentModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            padding: 16px;
            box-sizing: border-box;
        }

        #commentModal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--dark-bg);
            border-radius: 20px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
        }

        .light-mode .modal-content {
            background: var(--light-bg);
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 24px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            flex: 1;
        }

        .modal-header .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.25rem;
        }

        .modal-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
        }

        .comment-form {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-mode .comment-form {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        .comment-form textarea {
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            transition: all 0.3s;
            min-height: 120px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.05);
            color: inherit;
        }

        .light-mode .comment-form textarea {
            border: 1px solid #d1d5db;
            background: white;
        }

        .comment-form textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .comment-form button {
            background: linear-gradient(135deg, var(--secondary), #059669);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .comment-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .comment-form button i {
            margin-left: 8px;
        }

        .comments-section h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--light-text);
            display: flex;
            align-items: center;
        }

        .light-mode .comments-section h3 {
            color: var(--dark-text);
        }

        .comments-section h3 i {
            margin-left: 8px;
            color: var(--primary);
        }

        .comments-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .comment-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .light-mode .comment-item {
            background: white;
            border: 1px solid #f1f5f9;
        }

        .comment-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .comment-user {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-left: 12px;
        }

        .user-name {
            font-weight: 600;
            color: var(--light-text);
        }

        .light-mode .user-name {
            color: var(--dark-text);
        }

        .comment-date {
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .comment-text {
            color: var(--light-text);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .light-mode .comment-text {
            color: #374151;
        }

        .comment-actions {
            display: flex;
            gap: 16px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            transition: all 0.3s;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--light-text);
        }

        .light-mode .action-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .action-btn.liked {
            color: var(--primary);
        }

        .action-btn i {
            margin-left: 4px;
        }

        .replies-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-mode .replies-section {
            border-top: 1px solid #f1f5f9;
        }

        .reply-form {
            display: flex;
            margin-top: 12px;
            gap: 8px;
        }

        .reply-form input {
            flex: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            font-family: inherit;
            font-size: 0.875rem;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.05);
            color: inherit;
        }

        .light-mode .reply-form input {
            border: 1px solid #d1d5db;
            background: white;
        }

        .reply-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .reply-form button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .reply-form button:hover {
            background: var(--primary-dark);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            margin: 0;
        }

        /* دکمه کامنت در کارت غذا */
        .comment-btn {
            background: linear-gradient(45deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        .comment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .comment-btn i {
            margin-left: 5px;
        }

        /* استایل‌های ریسپانسیو برای مدال */
        @media (max-width: 768px) {
            .modal-content {
                width: 100%;
                border-radius: 16px;
                margin: 0 8px;
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .comment-form {
                padding: 16px;
            }
            
            .comment-actions {
                gap: 12px;
            }
            
            .action-btn {
                font-size: 0.8rem;
                padding: 4px 6px;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                margin: 0 4px;
            }
            
            .modal-header h2 {
                font-size: 1.2rem;
            }
            
            .comment-form textarea {
                padding: 12px;
            }
            
            .comment-item {
                padding: 12px;
            }
            
            .user-avatar {
                width: 32px;
                height: 32px;
            }
            
            .user-name {
                font-size: 0.875rem;
            }
            
            .comment-date {
                font-size: 0.75rem;
            }
            
            .comment-text {
                font-size: 0.875rem;
            }
            
            .action-btn {
                font-size: 0.75rem;
                padding: 3px 6px;
            }
        }
    </style>
</head>
<body>
    <!-- آیکون سبد خرید -->
    <div class="cart-icon" id="cart-icon">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-badge" id="cart-badge">0</span>
    </div>
    
    <!-- پنل سبد خرید -->
    <div class="cart-panel" id="cart-panel">
        <div class="cart-header">
            <h3>سبد خرید شما</h3>
            <button class="close-cart" id="close-cart">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="cart-items" id="cart-items">
            <div class="empty-cart">
                <i class="fas fa-shopping-basket"></i>
                <p>سبد خرید شما خالی است</p>
            </div>
        </div>
        
        <div class="cart-footer">
            <div class="cart-total">
                <span>جمع کل:</span>
                <span id="cart-total">۰ تومان</span>
            </div>
            <button class="checkout-btn" id="checkout-btn">
                تسویه حساب
            </button>
        </div>
    </div>

    <!-- مدال کامنت‌ها -->
    <div id="commentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>نظرات و پیشنهادات</h2>
                <button class="close-btn" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="comment-form">
                    <h3 class="text-lg font-semibold mb-3">نظر خود را ثبت کنید</h3>
                    <textarea id="commentText" placeholder="نظر، پیشنهاد یا تجربه خود از این غذا را بنویسید..."></textarea>
                    <button id="submitComment">
                        <i class="fas fa-paper-plane"></i> ارسال نظر
                    </button>
                </div>
                
                <div class="comments-section">
                    <h3><i class="fas fa-comments"></i> نظرات کاربران</h3>
                    <div id="commentsList" class="comments-list">
                        <!-- نظرات از API لود می‌شوند -->
                        <div class="empty-state">
                            <i class="fas fa-comment-slash"></i>
                            <p>هنوز نظری ثبت نشده است.</p>
                            <p class="text-sm mt-1">اولین نفری باشید که نظر می‌دهد!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-12 max-w-7xl relative">
        <!-- هدر -->
        <header class="text-center mb-16">
            <div class="absolute left-0 top-0">
                <button id="theme-toggle" class="p-3 rounded-full bg-black/20 backdrop-blur-md text-amber-400 shadow-lg hover:shadow-amber-400/30 transition-all">
                    <i class="fas fa-moon dark-mode-icon"></i>
                    <i class="fas fa-sun light-mode-icon hidden"></i>
                </button>
            </div>
            
            <div class="inline-block mb-8">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center shadow-lg">
                    <i class="fas fa-utensils text-white text-3xl"></i>
                </div>
            </div>
            
            <h1 id="restaurant-name" class="text-5xl font-extrabold mb-4 text-amber-400">منوی دیجیتال</h1>
            <h2 class="text-2xl font-medium text-gray-300 light-mode:text-gray-600 mb-6" id="restaurant-description">کافه رستوران <span class="font-bold text-amber-400">لوکس</span></h2>
            
            <div class="w-32 h-1.5 bg-gradient-to-r from-transparent via-amber-500 to-transparent mx-auto mt-6 rounded-full"></div>
        </header>

        <!-- لودر -->
        <div id="loading-section" class="text-center py-20">
            <div class="loader"></div>
            <p class="text-gray-400 light-mode:text-gray-600 mt-4 text-lg">در حال بارگذاری منو...</p>
        </div>

        <!-- دسته‌بندی‌ها -->
        <div id="categories-section" class="hidden flex overflow-x-auto pb-8 mb-12 scroll-smooth">
            <div class="flex space-x-6 space-x-reverse mx-auto px-4" id="categories-container">
                <button class="category-btn px-8 py-3 rounded-xl active" data-category="all">
                    <i class="fas fa-star ml-2"></i>
                    همه موارد
                </button>
                <!-- دسته‌بندی‌های داینامیک اینجا اضافه می‌شوند -->
            </div>
        </div>
        
        <!-- جستجو -->
        <div id="search-section" class="hidden mb-12 mx-auto max-w-2xl relative">
            <div class="relative glass-card rounded-xl overflow-hidden">
                <input type="text" id="search-input" placeholder="جستجو در منو..." 
                    class="w-full py-4 px-6 pr-14 bg-transparent focus:outline-none placeholder-gray-400 light-mode:placeholder-gray-500">
                <i class="fas fa-search absolute left-6 top-4 text-xl text-amber-500"></i>
                <button class="absolute left-6 top-4 text-xl text-amber-500 opacity-0 transition-all" id="clear-search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- لیست منو -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="menu-container">
            <!-- آیتم‌ها با JavaScript اضافه می‌شوند -->
        </div>

        <!-- پیام عدم یافتن محصول -->
        <div id="no-items-message" class="hidden col-span-full text-center py-20">
            <i class="fas fa-search text-5xl text-amber-500 mb-6 opacity-60"></i>
            <h3 class="text-3xl font-bold text-gray-300 light-mode:text-gray-700 mb-4">محصولی یافت نشد</h3>
            <p class="text-gray-400 light-mode:text-gray-600 text-xl">لطفاً عبارت جستجوی دیگری امتحان کنید</p>
        </div>
    </div>
    
    <!-- فوتر -->
    <footer class="glass-card mt-20 py-10 border-t border-white/10 light-mode:border-gray-200">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center space-x-8 space-x-reverse mb-8">
                <a href="#" class="w-12 h-12 rounded-full bg-black/20 light-mode:bg-white/70 backdrop-blur-md flex items-center justify-center text-xl text-amber-500 hover:text-white hover:bg-amber-600 transition-all">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="#" class="w-12 h-12 rounded-full bg-black/20 light-mode:bg-white/70 backdrop-blur-md flex items-center justify-center text-xl text-amber-500 hover:text-white hover:bg-amber-600 transition-all">
                    <i class="fab fa-telegram"></i>
                </a>
                <a href="#" class="w-12 h-12 rounded-full bg-black/20 light-mode:bg-white/70 backdrop-blur-md flex items-center justify-center text-xl text-amber-500 hover:text-white hover:bg-amber-600 transition-all">
                    <i class="fab fa-whatsapp"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto mb-8">
                <div class="glass-card p-4 rounded-lg">
                    <i class="fas fa-map-marker-alt text-2xl text-amber-500 mb-2"></i>
                    <p class="font-medium">تهران، خیابان نمونه، پلاک ۱۲۳</p>
                </div>
                <div class="glass-card p-4 rounded-lg">
                    <i class="fas fa-phone-alt text-2xl text-amber-500 mb-2"></i>
                    <p class="font-medium">۰۲۱-۱۲۳۴۵۶۷۸</p>
                </div>
                <div class="glass-card p-4 rounded-lg">
                    <i class="fas fa-clock text-2xl text-amber-500 mb-2"></i>
                    <p class="font-medium">هر روز ۸ صبح تا ۱۲ شب</p>
                </div>
            </div>
            
            <p class="text-sm text-gray-400 light-mode:text-gray-600">© ۲۰۲۳ کافه رستوران لوکس. تمام حقوق محفوظ است.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        // دریافت menuId از URL
        const params = new URLSearchParams(window.location.search);
        const menuId = params.get("id");

        // داده‌های منو - از API پر می‌شود
        let menuItems = [];
        let categories = [];
        
        // داده‌های سبد خرید
        let cart = [];
        
        // DOM Elements
        const loadingSection = document.getElementById('loading-section');
        const categoriesSection = document.getElementById('categories-section');
        const searchSection = document.getElementById('search-section');
        const categoriesContainer = document.getElementById('categories-container');
        const menuContainer = document.getElementById('menu-container');
        const noItemsMessage = document.getElementById('no-items-message');
        const restaurantName = document.getElementById('restaurant-name');
        const restaurantDescription = document.getElementById('restaurant-description');

        // تابع برای بارگذاری منو از API
        async function loadFullMenu() {
            const token = sessionStorage.getItem('accessToken');
            
            try {
                const response = await fetch(`http://135.125.238.202:7050/menu/show/${menuId}/`, {
                    method: "GET",
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const apiData = await response.json();
                
                // آپدیت اطلاعات رستوران
                updateRestaurantInfo(apiData);
                
                // تبدیل داده‌های API
                transformAPIData(apiData);
                
                // ایجاد تب‌های داینامیک
                createDynamicCategoryTabs();
                
                // مخفی کردن لودر و نمایش محتوا
                loadingSection.classList.add('hidden');
                categoriesSection.classList.remove('hidden');
                searchSection.classList.remove('hidden');
                
                // نمایش منو
                displayMenu(menuItems);

            } catch (error) {
                console.error('Error loading menu:', error);
                showError('خطا در بارگذاری منو. لطفاً صفحه را مجدداً بارگذاری کنید.');
            }
        }

        // آپدیت اطلاعات رستوران
        function updateRestaurantInfo(apiData) {
            restaurantName.textContent = apiData.name || "منوی دیجیتال";
            if (apiData.owner_info?.first_name) {
                restaurantDescription.textContent = `مدیریت: ${apiData.owner_info.first_name}`;
            }
            
            // آپدیت title صفحه
            document.title = `${apiData.name} | منوی دیجیتال`;
        }

        // تابع برای تبدیل داده‌های API به فرمت مورد نیاز
        function transformAPIData(apiData) {
            categories = [];
            menuItems = [];
            
            // پردازش دسته‌بندی‌ها
            apiData.menu_categories.forEach(category => {
                categories.push({
                    id: category.id,
                    name: category.name,
                    type: `category-${category.id}`
                });
                
                // پردازش آیتم‌های هر دسته‌بندی
                category.menu_items.forEach(item => {
                    menuItems.push({
                        id: item.id,
                        name: item.name,
                        category: `category-${category.id}`,
                        categoryName: category.name,
                        price: parseFloat(item.price),
                        description: item.description || 'توضیحاتی برای این آیتم موجود نیست',
                        popular: Math.random() > 0.7, // مقدار تصادفی برای نمایش
                        image: item.image_path ? `http://135.125.238.202:7050${item.image_path}` : getDefaultImage(category.name),
                        ingredients: getRandomIngredients(),
                        isAvailable: item.is_available,
                        options: item.options
                    });
                });
            });
        }

        // تابع برای ایجاد تب‌های داینامیک
        function createDynamicCategoryTabs() {
            // پاک کردن تب‌های موجود (به جز تب "همه")
            const allTab = categoriesContainer.querySelector('[data-category="all"]');
            categoriesContainer.innerHTML = '';
            categoriesContainer.appendChild(allTab);
            
            // ایجاد تب‌های جدید بر اساس دسته‌بندی‌های واقعی
            categories.forEach(category => {
                const tab = document.createElement('button');
                tab.className = 'category-btn px-8 py-3 rounded-xl flex items-center';
                tab.dataset.category = category.type;
                
                // آیکون بر اساس نوع دسته‌بندی
                let icon = 'fas fa-utensils';
                if (category.name.includes('نوشیدنی') || category.name.includes('دسته بندی 2')) {
                    icon = 'fas fa-mug-hot';
                } else if (category.name.includes('دسر') || category.name.includes('دسته بندی 3')) {
                    icon = 'fas fa-ice-cream';
                } else if (category.name.includes('صبحانه')) {
                    icon = 'fas fa-sun';
                }
                
                tab.innerHTML = `
                    <i class="${icon} ml-2"></i>
                    ${category.name}
                `;
                
                categoriesContainer.appendChild(tab);
            });
        }

        // تابع برای دریافت تصویر پیش‌فرض بر اساس دسته‌بندی
        function getDefaultImage(categoryName) {
            const defaultImages = {
                'نوشیدنی': 'https://images.unsplash.com/photo-1517701550927-30cf4ba1dba5?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                'دسر': 'https://images.unsplash.com/photo-1571115177098-24ec42ed204d?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                'غذای اصلی': 'https://images.unsplash.com/photo-1603360946369-dc9bb6258143?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                'صبحانه': 'https://images.unsplash.com/photo-1558584724-0e4d32ca55a4?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'
            };
            
            for (const [key, image] of Object.entries(defaultImages)) {
                if (categoryName.includes(key)) {
                    return image;
                }
            }
            
            return 'https://images.unsplash.com/photo-1558030006-450675393462?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80';
        }

        // تابع برای تولید مواد تشکیل‌دهنده تصادفی
        function getRandomIngredients() {
            const allIngredients = [
                "اسپرسو", "شیر تازه", "پودر کاکائو", "دانه قهوه عربیکا", "شیر بخار داده شده",
                "شیر وانیلی", "یخ", "نعنا تازه", "لیمو", "شکر قهوه‌ای", "سودا", "انبه",
                "پاپایا", "آناناس", "موز", "تخم مرغ", "سوسیس", "قارچ", "لوبیا", "نان تست",
                "گوجه", "فلفل دلمه‌ای", "پنکیک", "عسل", "توت فرنگی", "بلوبری", "خامه",
                "گوشت آنتری کات", "سیب زمینی", "سبزیجات", "پاستا", "خامه", "پنیر پارمزان",
                "کاهو رومی", "نان کروتون", "سس سزار", "پنیر خامه‌ای", "بیسکویت", "ماسکارپونه",
                "بیسکویت لیدی فینگر", "قهوه", "شکلات بلژیکی", "بستنی وانیلی"
            ];
            
            const count = Math.floor(Math.random() * 3) + 2; // 2-4 ماده
            const shuffled = allIngredients.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // تابع نمایش منو
        function displayMenu(items) {
            menuContainer.innerHTML = '';
            
            if (items.length === 0) {
                noItemsMessage.classList.remove('hidden');
                return;
            }
            
            noItemsMessage.classList.add('hidden');
            
            items.forEach((item, index) => {
                const menuItem = document.createElement('div');
                menuItem.className = `menu-item glass-card rounded-xl overflow-hidden fade-in ${!item.isAvailable ? 'opacity-60' : ''}`;
                menuItem.style.animationDelay = `${index * 0.1}s`;
                menuItem.dataset.id = item.id;
                menuItem.dataset.category = item.category;
                
                let popularBadge = '';
                if (item.popular) {
                    popularBadge = `
                        <div class="popular-badge absolute top-4 left-4 bg-gradient-to-r from-amber-500 to-pink-600 text-white px-4 py-1 rounded-full text-sm font-bold z-10">
                            <i class="fas fa-crown mr-1"></i> ویژه
                        </div>
                    `;
                }
                
                let unavailableOverlay = '';
                if (!item.isAvailable) {
                    unavailableOverlay = `
                        <div class="absolute inset-0 bg-black/60 flex items-center justify-center z-20">
                            <span class="bg-slate-800 text-white px-4 py-2 rounded-full font-bold">ناموجود</span>
                        </div>
                    `;
                }
                
                let ingredients = '';
                if (item.ingredients) {
                    ingredients = `
                        <div class="mt-4 pt-4 border-t border-white/10 light-mode:border-gray-200">
                            <h4 class="text-sm font-semibold text-amber-500 mb-2">مواد تشکیل‌دهنده:</h4>
                            <div class="flex flex-wrap gap-2">
                                ${item.ingredients.map(ing => `
                                    <span class="text-xs bg-black/20 light-mode:bg-white/70 px-2 py-1 rounded-full backdrop-blur-sm">
                                        ${ing}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                menuItem.innerHTML = `
                    <div class="relative h-64 overflow-hidden">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover ${!item.isAvailable ? 'grayscale' : ''}">
                        ${popularBadge}
                        ${unavailableOverlay}
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                            <h3 class="text-xl font-bold text-white">${item.name}</h3>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <p class="text-gray-300 light-mode:text-gray-600 text-sm leading-relaxed">${item.description}</p>
                            <span class="price-tag text-lg font-bold px-4 py-1 rounded-r-full -mr-5 -mt-5">${item.price.toLocaleString()} تومان</span>
                        </div>
                        ${ingredients}
                        <button class="add-to-cart w-full mt-6 py-3 text-white rounded-lg flex items-center justify-center space-x-2 space-x-reverse font-medium ${!item.isAvailable ? 'bg-gray-400 cursor-not-allowed' : ''}" 
                                ${!item.isAvailable ? 'disabled' : ''}>
                            <i class="fas fa-plus"></i>
                            <span>${!item.isAvailable ? 'ناموجود' : 'افزودن به سبد'}</span>
                        </button>
                        <button class="comment-btn w-full mt-3" data-id="${item.id}" data-title="${item.name}">
                            <i class="fas fa-comment"></i>
                            ثبت نظر
                        </button>
                    </div>
                `;
                
                menuContainer.appendChild(menuItem);
            });

            // اضافه کردن event listener برای دکمه‌های کامنت
            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const foodId = this.dataset.id;
                    const foodTitle = this.dataset.title;
                    openCommentModal(foodId, foodTitle);
                });
            });
        }

        // تابع نمایش سبد خرید
        function renderCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartBadge = document.getElementById('cart-badge');
            const cartTotal = document.getElementById('cart-total');
            
            // به‌روزرسانی تعداد آیتم‌ها
            cartBadge.textContent = cart.reduce((total, item) => total + item.quantity, 0);
            
            // محاسبه جمع کل
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotal.textContent = total.toLocaleString() + ' تومان';
            
            // اگر سبد خرید خالی است
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-basket"></i>
                        <p>سبد خرید شما خالی است</p>
                    </div>
                `;
                return;
            }
            
            // نمایش آیتم‌های سبد خرید
            cartItemsContainer.innerHTML = cart.map(item => `
                <div class="cart-item" data-id="${item.id}">
                    <div class="cart-item-img">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price.toLocaleString()} تومان</div>
                        <div class="cart-item-actions">
                            <div class="remove-item" onclick="removeFromCart(${item.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                            <div class="quantity-control">
                                <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                                <input type="text" class="quantity-input" value="${item.quantity}" readonly>
                                <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // افزودن به سبد خرید
        function addToCart(itemId) {
            const item = menuItems.find(item => item.id === itemId);
            
            if (!item || !item.isAvailable) return;
            
            // بررسی وجود آیتم در سبد خرید
            const existingItem = cart.find(cartItem => cartItem.id === itemId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...item,
                    quantity: 1
                });
            }
            
            renderCart();
            
            // افکت موفقیت‌آمیز
            Toastify({
                text: `${item.name} به سبد خرید اضافه شد`,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "left",
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                stopOnFocus: true,
            }).showToast();
        }
        
        // حذف از سبد خرید
        function removeFromCart(itemId) {
            cart = cart.filter(item => item.id !== itemId);
            renderCart();
        }
        
        // به‌روزرسانی تعداد آیتم
        function updateQuantity(itemId, change) {
            const item = cart.find(item => item.id === itemId);
            
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity < 1) {
                removeFromCart(itemId);
            } else {
                renderCart();
            }
        }
        
        // تسویه حساب
        function checkout() {
            if (cart.length === 0) {
                Toastify({
                    text: "سبد خرید شما خالی است",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "left",
                    backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
                    stopOnFocus: true,
                }).showToast();
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            Swal.fire({
                title: 'تسویه حساب',
                html: `مبلغ قابل پرداخت: <b>${total.toLocaleString()} تومان</b><br><br>لطفاً روش پرداخت را انتخاب کنید`,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'پرداخت آنلاین',
                cancelButtonText: 'پرداخت در محل',
                showDenyButton: true,
                denyButtonText: 'انصراف',
                customClass: {
                    confirmButton: 'bg-gradient-to-r from-amber-500 to-amber-600',
                    cancelButton: 'bg-gradient-to-r from-gray-500 to-gray-600',
                    denyButton: 'bg-gradient-to-r from-red-500 to-red-600'
                },
                buttonsStyling: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // پرداخت آنلاین
                    Swal.fire(
                        'پرداخت آنلاین',
                        'به صفحه پرداخت هدایت می‌شوید...',
                        'info'
                    );
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    // پرداخت در محل
                    Swal.fire(
                        'سفارش ثبت شد',
                        `سفارش شما با موفقیت ثبت شد و به مبلغ ${total.toLocaleString()} تومان آماده ارسال است.`,
                        'success'
                    );
                    cart = [];
                    renderCart();
                }
            });
        }

        // فیلتر بر اساس دسته‌بندی
        function filterByCategory(category) {
            const categoryBtns = document.querySelectorAll('.category-btn');
            categoryBtns.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            if (category === 'all') {
                displayMenu(menuItems);
            } else {
                const filteredItems = menuItems.filter(item => item.category === category);
                displayMenu(filteredItems);
            }
        }

        // جستجو در منو
        function searchMenu(query) {
            const clearBtn = document.getElementById('clear-search');
            if (query.length > 0) {
                clearBtn.style.opacity = '1';
                clearBtn.style.pointerEvents = 'auto';
            } else {
                clearBtn.style.opacity = '0';
                clearBtn.style.pointerEvents = 'none';
            }
            
            const filteredItems = menuItems.filter(item => 
                item.name.includes(query) || 
                item.description.includes(query) ||
                (item.ingredients && item.ingredients.some(ing => ing.includes(query)))
            );
            displayMenu(filteredItems);
        }

        // تغییر تم
        function toggleDarkMode() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('lightMode', document.body.classList.contains('light-mode'));
            
            const darkIcon = document.querySelector('.dark-mode-icon');
            const lightIcon = document.querySelector('.light-mode-icon');
            
            if (document.body.classList.contains('light-mode')) {
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            } else {
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            }
        }

        // نمایش خطا
        function showError(message) {
            loadingSection.innerHTML = `
                <div class="text-center py-10 text-red-500">
                    <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                    <p class="text-xl mb-4">${message}</p>
                    <button onclick="location.reload()" class="mt-4 bg-amber-500 text-white px-6 py-3 rounded-full hover:bg-amber-600 transition text-lg">
                        بارگذاری مجدد
                    </button>
                </div>
            `;
        }

        // مدیریت مدال کامنت‌ها
        const modal = document.getElementById("commentModal");
        const closeModal = document.getElementById("closeModal");
        const submitComment = document.getElementById("submitComment");
        const commentsList = document.getElementById("commentsList");

        const token = sessionStorage.getItem('accessToken');
        let baseURL = "http://135.125.238.202:7050";

        // باز کردن مدال
        function openCommentModal(foodId, foodTitle) {
            modal.classList.add("active");
            document.body.style.overflow = "hidden";

            modal.dataset.foodId = foodId;
            
            // آپدیت هدر مدال با نام غذا
            const modalHeader = modal.querySelector(".modal-header h2");
            modalHeader.textContent = `نظرات و پیشنهادات - ${foodTitle}`;

            loadComments(foodId);
        }

        // بستن مدال
        closeModal.addEventListener("click", () => {
            modal.classList.remove("active");
            document.body.style.overflow = "auto";
        });

        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.classList.remove("active");
                document.body.style.overflow = "auto";
            }
        });

        // ثبت نظر جدید
        submitComment.addEventListener("click", async () => {
            const commentText = document.getElementById("commentText").value.trim();
            if (!commentText) return alert("❗ لطفا متنی وارد کنید");

            const foodId = modal.dataset.foodId;

            const formData = new FormData();
            formData.append("item", foodId);
            formData.append("text", commentText);

            await fetch(`${baseURL}/comment/create/`, {
                method: "POST",
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            document.getElementById("commentText").value = "";
            await loadComments(foodId);
        });

        // 📌 گرفتن کامنت‌های اصلی
        async function loadComments(foodId) {
            commentsList.innerHTML = "<div class='empty-state'><i class='fas fa-spinner fa-spin'></i><p>در حال بارگذاری نظرات...</p></div>";
            try {
                const res = await fetch(`${baseURL}/comment/parents/${foodId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await res.json();

                if (!data.length) {
                    commentsList.innerHTML = "<div class='empty-state'><i class='fas fa-comment-slash'></i><p>هنوز نظری ثبت نشده است.</p><p class='text-sm mt-1'>اولین نفری باشید که نظر می‌دهد!</p></div>";
                    return;
                }

                commentsList.innerHTML = "";
                for (const comment of data) {
                    await renderComment(comment);
                }
            } catch (err) {
                commentsList.innerHTML = "<div class='empty-state'><i class='fas fa-exclamation-triangle'></i><p>خطا در بارگذاری نظرات</p></div>";
            }
        }

        async function userID() {
            const token = sessionStorage.getItem("accessToken");
            try {
                const res = await fetch(`http://135.125.238.202:7050/user/info/`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const user = await res.json();

                let currentUserId = user.id;
                return currentUserId;
            } catch (error) {
                console.error(error);
            }
        };

        // 🔹 تابع بارگذاری ریپلای‌ها (برای هر کامنت)
        async function loadReplies(commentId, container) {
            try {
                const res = await fetch(`${baseURL}/comment/descendants/`, {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ comment_id: commentId })
                });
                const replies = await res.json();

                container.innerHTML = "";

                const currentUserId = await userID();

                for (const r of replies) {
                    // بررسی اینکه آیا کاربر فعلی ریپلای را لایک کرده یا نه
                    let replyLiked = false;
                    try {
                        const likeRes = await fetch(`${baseURL}/comment/${r.id}/like/`, {
                            headers: { "Authorization": `Bearer ${token}` }
                        });
                        if (likeRes.ok) {
                            const replyLikes = await likeRes.json();
                            replyLiked = replyLikes.some(
                                like => Number(like.user) === Number(currentUserId) && like.comment === r.id
                            );
                        }
                    } catch (err) {
                        console.error("❌ خطا در گرفتن لایک‌های ریپلای:", err);
                    }

                    const replyEl = document.createElement("div");
                    replyEl.className = "comment-item";
                    replyEl.innerHTML = `
                        <div class="comment-header">
                            <div class="comment-user">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <div class="user-name">کاربر</div>
                                    <div class="comment-date">${new Date(r.created_at).toLocaleDateString('fa-IR')}</div>
                                </div>
                            </div>
                        </div>
                        <div class="comment-text">${r.text}</div>
                        <div class="comment-actions">
                            <button class="action-btn like-btn ${replyLiked ? 'liked' : ''}" data-id="${r.id}">
                                <i class="fas fa-thumbs-up"></i>
                                <span class="like-count">${r.like_count || 0}</span>
                            </button>
                        </div>
                    `;

                    // 📌 لایک / آن‌لایک ریپلای
                    const replyLikeBtn = replyEl.querySelector(".like-btn");
                    replyLikeBtn.addEventListener("click", async () => {
                        if (replyLikeBtn.classList.contains("liked")) {
                            const res = await fetch(`${baseURL}/comment/${r.id}/like/`, {
                                method: "DELETE",
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (res.ok) {
                                replyLikeBtn.classList.remove("liked");
                                replyLikeBtn.querySelector(".like-count").textContent =
                                    parseInt(replyLikeBtn.querySelector(".like-count").textContent) - 1;
                            }
                        } else {
                            const res = await fetch(`${baseURL}/comment/${r.id}/like/`, {
                                method: "POST",
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (res.ok) {
                                replyLikeBtn.classList.add("liked");
                                replyLikeBtn.querySelector(".like-count").textContent =
                                    parseInt(replyLikeBtn.querySelector(".like-count").textContent) + 1;
                            }
                        }
                    });

                    container.appendChild(replyEl);
                }
            } catch (err) {
                console.error("❌ خطا در گرفتن ریپلای‌ها:", err);
            }
        }

        // 🔹 تابع رندر کامنت اصلی و ریپلای‌ها
        async function renderComment(comment) {
            const commentDiv = document.createElement("div");
            commentDiv.className = "comment-item";

            // بررسی اینکه آیا کاربر فعلی لایک کرده یا نه
            let liked = false;
            try {
                const res = await fetch(`${baseURL}/comment/${comment.id}/like/`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (res.ok) {
                    const likes = await res.json();
                    const currentUserId = await userID();
                    liked = likes.some(
                        like => Number(like.user) === Number(currentUserId) && like.comment === comment.id
                    );
                }
            } catch (err) {
                console.error("❌ خطا در گرفتن لایک‌های کامنت:", err);
            }

            // گرفتن تعداد پاسخ‌ها
            let replyCount = 0;
            try {
                const replyRes = await fetch(`${baseURL}/comment/descendants/`, {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ comment_id: comment.id })
                });
                if (replyRes.ok) {
                    const replies = await replyRes.json();
                    replyCount = replies.length;
                }
            } catch (err) {
                console.error("❌ خطا در گرفتن تعداد پاسخ‌ها:", err);
            }

            commentDiv.innerHTML = `
                <div class="comment-header">
                    <div class="comment-user">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div class="user-name">کاربر</div>
                            <div class="comment-date">${new Date(comment.created_at).toLocaleDateString('fa-IR')}</div>
                        </div>
                    </div>
                </div>
                <div class="comment-text">${comment.text}</div>
                <div class="comment-actions">
                    <button class="action-btn like-btn ${liked ? "liked" : ""}" data-id="${comment.id}">
                        <i class="fas fa-thumbs-up"></i>
                        <span class="like-count">${comment.like_count || 0}</span>
                    </button>
                    <button class="action-btn reply-btn" data-id="${comment.id}">
                        <i class="fas fa-reply"></i>
                        پاسخ (${replyCount})
                    </button>
                </div>
                <div class="replies-section">
                    <div class="replies"></div>
                </div>
            `;

            // 📌 لایک / آن‌لایک برای کامنت اصلی
            commentDiv.querySelector(".like-btn").addEventListener("click", async (e) => {
                const btn = e.currentTarget;
                const cId = btn.dataset.id;

                try {
                    if (btn.classList.contains("liked")) {
                        const res = await fetch(`${baseURL}/comment/${cId}/like/`, {
                            method: "DELETE",
                            headers: { "Authorization": `Bearer ${token}` }
                        });
                        if (res.ok) {
                            btn.classList.remove("liked");
                            btn.querySelector(".like-count").textContent =
                                parseInt(btn.querySelector(".like-count").textContent) - 1;
                        }
                    } else {
                        const res = await fetch(`${baseURL}/comment/${cId}/like/`, {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${token}` }
                        });
                        if (res.ok) {
                            btn.classList.add("liked");
                            btn.querySelector(".like-count").textContent =
                                parseInt(btn.querySelector(".like-count").textContent) + 1;
                        }
                    }
                } catch (err) {
                    console.error("❌ خطا در لایک/آن‌لایک کامنت:", err);
                }
            });

            // 📌 دکمه پاسخ (نمایش ریپلای‌ها و فرم ارسال)
            commentDiv.querySelector(".reply-btn").addEventListener("click", async (e) => {
                const cId = e.currentTarget.dataset.id;
                const repliesDiv = commentDiv.querySelector(".replies");

                // لود ریپلای‌ها
                await loadReplies(cId, repliesDiv);

                // فرم ارسال ریپلای جدید
                const replyForm = document.createElement("div");
                replyForm.className = "reply-form";
                replyForm.innerHTML = `
                    <input type="text" class="reply-input" placeholder="پاسخ خود را بنویسید..." />
                    <button class="send-reply">ارسال</button>
                `;
                repliesDiv.appendChild(replyForm);

                replyForm.querySelector(".send-reply").addEventListener("click", async () => {
                    const replyText = replyForm.querySelector(".reply-input").value.trim();
                    if (!replyText) return alert("❗ لطفا متنی وارد کنید");

                    const formData = new FormData();
                    formData.append("item", modal.dataset.foodId);
                    formData.append("parent", cId);
                    formData.append("text", replyText);

                    const res = await fetch(`${baseURL}/comment/create/`, {
                        method: "POST",
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    if (res.ok) {
                        replyForm.querySelector(".reply-input").value = "";
                        await loadReplies(cId, repliesDiv);
                        
                        // آپدیت تعداد پاسخ‌ها
                        const replyBtn = commentDiv.querySelector(".reply-btn");
                        const currentCount = parseInt(replyBtn.textContent.match(/\((\d+)\)/)[1]);
                        replyBtn.innerHTML = `<i class="fas fa-reply"></i> پاسخ (${currentCount + 1})`;
                    } else {
                        alert("❌ خطا در ارسال پاسخ");
                    }
                });
            });

            commentsList.appendChild(commentDiv);
        }

        // رویدادهای صفحه
        document.addEventListener('DOMContentLoaded', () => {
            if (menuId) {
                loadFullMenu();
            } else {
                showError('شناسه منو یافت نشد. لطفاً از طریق لینک صحیح وارد شوید.');
            }
            
            // رویدادهای دکمه‌های دسته‌بندی (delegated)
            document.getElementById('categories-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('category-btn') || e.target.closest('.category-btn')) {
                    const btn = e.target.classList.contains('category-btn') ? e.target : e.target.closest('.category-btn');
                    filterByCategory(btn.dataset.category);
                }
            });
            
            // رویداد جستجو
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                searchMenu(e.target.value);
            });
            
            // پاک کردن جستجو
            document.getElementById('clear-search').addEventListener('click', () => {
                searchInput.value = '';
                searchMenu('');
                searchInput.focus();
            });
            
            // رویداد تغییر تم
            document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);
            
            // بررسی تم ذخیره شده
            if (localStorage.getItem('lightMode') === 'true') {
                document.body.classList.add('light-mode');
                document.querySelector('.dark-mode-icon').classList.add('hidden');
                document.querySelector('.light-mode-icon').classList.remove('hidden');
            }
            
            // رویدادهای سبد خرید
            document.getElementById('cart-icon').addEventListener('click', () => {
                document.getElementById('cart-panel').classList.add('open');
            });
            
            document.getElementById('close-cart').addEventListener('click', () => {
                document.getElementById('cart-panel').classList.remove('open');
            });
            
            document.getElementById('checkout-btn').addEventListener('click', checkout);
            
            // شبیه سازی کلیک روی دکمه افزودن به سبد
            document.addEventListener('click', (e) => {
                if (e.target.closest('.add-to-cart')) {
                    const menuItem = e.target.closest('.menu-item');
                    const itemId = parseInt(menuItem.dataset.id);
                    const btn = e.target.closest('.add-to-cart');
                    
                    if (btn.disabled) return;
                    
                    // افکت افزودن به سبد
                    btn.innerHTML = '<i class="fas fa-check"></i> <span>افزوده شد</span>';
                    btn.classList.remove('from-amber-500', 'to-amber-600');
                    btn.classList.add('from-green-500', 'to-green-600');
                    
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-plus"></i> <span>افزودن به سبد</span>';
                        btn.classList.remove('from-green-500', 'to-green-600');
                        btn.classList.add('from-amber-500', 'to-amber-600');
                    }, 2000);
                    
                    // افزودن به سبد خرید
                    addToCart(itemId);
                }
            });
        });
    </script>
</body>
</html>