<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منوی دیجیتال لوکس | کافه رستوران</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --secondary: #10b981;
            --dark-bg: #1a202c;
            --light-bg: #f8fafc;
            --dark-text: #1e293b;
            --light-text: #f8fafc;
        }
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            background-color: var(--dark-bg);
            color: var(--light-text);
            transition: all 0.5s ease;
        }
        
        body.light-mode {
            background-color: var(--light-bg);
            color: var(--dark-text);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .light-mode .glass-card {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        .menu-item {
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
        }
        
        .menu-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .light-mode .menu-item:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .category-btn {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .light-mode .category-btn {
            background: rgba(255,255,255,0.7);
        }
        
        .category-btn.active {
            background: linear-gradient(45deg, rgba(245,158,11,0.8), rgba(239,68,68,0.6));
            color: white;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }
        
        .popular-badge {
            background: linear-gradient(45deg, var(--primary), #ef4444);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .price-tag {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .add-to-cart {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            transition: all 0.3s ease;
        }
        
        .add-to-cart:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }
        
        /* استایل‌های سبد خرید */
        .cart-icon {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .cart-icon:hover {
            transform: scale(1.1);
        }
        
        .cart-icon i {
            font-size: 24px;
            color: var(--primary);
        }
        
        .cart-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .cart-panel {
            position: fixed;
            top: 0;
            left: -450px;
            width: 450px;
            height: 100vh;
            background: var(--dark-bg);
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: -5px 0 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .light-mode .cart-panel {
            background: var(--light-bg);
            box-shadow: -5px 0 30px rgba(0,0,0,0.1);
        }
        
        .cart-panel.open {
            left: 0;
        }
        
        .cart-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .light-mode .cart-header {
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .cart-header h3 {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }
        
        .close-cart {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cart-item {
            display: flex;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .light-mode .cart-item {
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .cart-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .cart-item-img {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            margin-left: 15px;
        }
        
        .cart-item-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .cart-item-details {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .cart-item-price {
            color: var(--primary);
            font-weight: 700;
        }
        
        .cart-item-actions {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 30px;
            padding: 2px;
        }
        
        .light-mode .quantity-control {
            background: rgba(0,0,0,0.05);
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }
        
        .quantity-input {
            width: 40px;
            text-align: center;
            background: transparent;
            border: none;
            color: inherit;
            font-weight: 600;
        }
        
        .remove-item {
            margin-right: 15px;
            color: #ef4444;
            cursor: pointer;
            font-size: 18px;
        }
        
        .cart-footer {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .light-mode .cart-footer {
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 18px;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }
        
        .empty-cart {
            text-align: center;
            padding: 40px 0;
            color: #9ca3af;
        }
        
        .empty-cart i {
            font-size: 50px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .cart-panel {
                width: 90%;
                left: -100%;
            }
            
            .cart-panel.open {
                left: 0;
            }
        }
        
        /* بهبود خوانایی متن */
        .light-mode .text-muted {
            color: #4b5563 !important;
        }
        
        .dark-mode .text-muted {
            color: #d1d5db !important;
        }
        
        /* اسکرول بار سفارشی */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        .light-mode ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
        }

        /* لودر */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- آیکون سبد خرید -->
    <div class="cart-icon" id="cart-icon">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-badge" id="cart-badge">0</span>
    </div>
    
    <!-- پنل سبد خرید -->
    <div class="cart-panel" id="cart-panel">
        <div class="cart-header">
            <h3>سبد خرید شما</h3>
            <button class="close-cart" id="close-cart">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="cart-items" id="cart-items">
            <div class="empty-cart">
                <i class="fas fa-shopping-basket"></i>
                <p>سبد خرید شما خالی است</p>
            </div>
        </div>
        
        <div class="cart-footer">
            <div class="cart-total">
                <span>جمع کل:</span>
                <span id="cart-total">۰ تومان</span>
            </div>
            <button class="checkout-btn" id="checkout-btn">
                تسویه حساب
            </button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-12 max-w-7xl relative">
        <!-- هدر -->
        <header class="text-center mb-16">
            <div class="absolute left-0 top-0">
                <button id="theme-toggle" class="p-3 rounded-full bg-black/20 backdrop-blur-md text-amber-400 shadow-lg hover:shadow-amber-400/30 transition-all">
                    <i class="fas fa-moon dark-mode-icon"></i>
                    <i class="fas fa-sun light-mode-icon hidden"></i>
                </button>
            </div>
            
            <div class="inline-block mb-8">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center shadow-lg">
                    <i class="fas fa-utensils text-white text-3xl"></i>
                </div>
            </div>
            
            <h1 id="restaurant-name" class="text-5xl font-extrabold mb-4 text-amber-400">منوی دیجیتال</h1>
            <h2 class="text-2xl font-medium text-gray-300 light-mode:text-gray-600 mb-6" id="restaurant-description">کافه رستوران <span class="font-bold text-amber-400">لوکس</span></h2>
            
            <div class="w-32 h-1.5 bg-gradient-to-r from-transparent via-amber-500 to-transparent mx-auto mt-6 rounded-full"></div>
        </header>

        <!-- لودر -->
        <div id="loading-section" class="text-center py-20">
            <div class="loader"></div>
            <p class="text-gray-400 light-mode:text-gray-600 mt-4 text-lg">در حال بارگذاری منو...</p>
        </div>

        <!-- دسته‌بندی‌ها -->
        <div id="categories-section" class="hidden flex overflow-x-auto pb-8 mb-12 scroll-smooth">
            <div class="flex space-x-6 space-x-reverse mx-auto px-4" id="categories-container">
                <button class="category-btn px-8 py-3 rounded-xl active" data-category="all">
                    <i class="fas fa-star ml-2"></i>
                    همه موارد
                </button>
                <!-- دسته‌بندی‌های داینامیک اینجا اضافه می‌شوند -->
            </div>
        </div>
        
        <!-- جستجو -->
        <div id="search-section" class="hidden mb-12 mx-auto max-w-2xl relative">
            <div class="relative glass-card rounded-xl overflow-hidden">
                <input type="text" id="search-input" placeholder="جستجو در منو..." 
                    class="w-full py-4 px-6 pr-14 bg-transparent focus:outline-none placeholder-gray-400 light-mode:placeholder-gray-500">
                <i class="fas fa-search absolute left-6 top-4 text-xl text-amber-500"></i>
                <button class="absolute left-6 top-4 text-xl text-amber-500 opacity-0 transition-all" id="clear-search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- لیست منو -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="menu-container">
            <!-- آیتم‌ها با JavaScript اضافه می‌شوند -->
        </div>

        <!-- پیام عدم یافتن محصول -->
        <div id="no-items-message" class="hidden col-span-full text-center py-20">
            <i class="fas fa-search text-5xl text-amber-500 mb-6 opacity-60"></i>
            <h3 class="text-3xl font-bold text-gray-300 light-mode:text-gray-700 mb-4">محصولی یافت نشد</h3>
            <p class="text-gray-400 light-mode:text-gray-600 text-xl">لطفاً عبارت جستجوی دیگری امتحان کنید</p>
        </div>
    </div>
    
    <!-- فوتر -->
    <footer class="glass-card mt-20 py-10 border-t border-white/10 light-mode:border-gray-200">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center space-x-8 space-x-reverse mb-8">
                <a href="#" class="w-12 h-12 rounded-full bg-black/20 light-mode:bg-white/70 backdrop-blur-md flex items-center justify-center text-xl text-amber-500 hover:text-white hover:bg-amber-600 transition-all">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="#" class="w-12 h-12 rounded-full bg-black/20 light-mode:bg-white/70 backdrop-blur-md flex items-center justify-center text-xl text-amber-500 hover:text-white hover:bg-amber-600 transition-all">
                    <i class="fab fa-telegram"></i>
                </a>
                <a href="#" class="w-12 h-12 rounded-full bg-black/20 light-mode:bg-white/70 backdrop-blur-md flex items-center justify-center text-xl text-amber-500 hover:text-white hover:bg-amber-600 transition-all">
                    <i class="fab fa-whatsapp"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto mb-8">
                <div class="glass-card p-4 rounded-lg">
                    <i class="fas fa-map-marker-alt text-2xl text-amber-500 mb-2"></i>
                    <p class="font-medium">تهران، خیابان نمونه، پلاک ۱۲۳</p>
                </div>
                <div class="glass-card p-4 rounded-lg">
                    <i class="fas fa-phone-alt text-2xl text-amber-500 mb-2"></i>
                    <p class="font-medium">۰۲۱-۱۲۳۴۵۶۷۸</p>
                </div>
                <div class="glass-card p-4 rounded-lg">
                    <i class="fas fa-clock text-2xl text-amber-500 mb-2"></i>
                    <p class="font-medium">هر روز ۸ صبح تا ۱۲ شب</p>
                </div>
            </div>
            
            <p class="text-sm text-gray-400 light-mode:text-gray-600">© ۲۰۲۳ کافه رستوران لوکس. تمام حقوق محفوظ است.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        // دریافت menuId از URL
        const params = new URLSearchParams(window.location.search);
        const menuId = params.get("id");

        // داده‌های منو - از API پر می‌شود
        let menuItems = [];
        let categories = [];
        
        // داده‌های سبد خرید
        let cart = [];
        
        // DOM Elements
        const loadingSection = document.getElementById('loading-section');
        const categoriesSection = document.getElementById('categories-section');
        const searchSection = document.getElementById('search-section');
        const categoriesContainer = document.getElementById('categories-container');
        const menuContainer = document.getElementById('menu-container');
        const noItemsMessage = document.getElementById('no-items-message');
        const restaurantName = document.getElementById('restaurant-name');
        const restaurantDescription = document.getElementById('restaurant-description');

        // تابع برای بارگذاری منو از API
        async function loadFullMenu() {
            const token = sessionStorage.getItem('accessToken');
            
            try {
                const response = await fetch(`http://135.125.238.202:7050/menu/show/${menuId}/`, {
                    method: "GET",
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const apiData = await response.json();
                
                // آپدیت اطلاعات رستوران
                updateRestaurantInfo(apiData);
                
                // تبدیل داده‌های API
                transformAPIData(apiData);
                
                // ایجاد تب‌های داینامیک
                createDynamicCategoryTabs();
                
                // مخفی کردن لودر و نمایش محتوا
                loadingSection.classList.add('hidden');
                categoriesSection.classList.remove('hidden');
                searchSection.classList.remove('hidden');
                
                // نمایش منو
                displayMenu(menuItems);

            } catch (error) {
                console.error('Error loading menu:', error);
                showError('خطا در بارگذاری منو. لطفاً صفحه را مجدداً بارگذاری کنید.');
            }
        }

        // آپدیت اطلاعات رستوران
        function updateRestaurantInfo(apiData) {
            restaurantName.textContent = apiData.name || "منوی دیجیتال";
            if (apiData.owner_info?.first_name) {
                restaurantDescription.textContent = `مدیریت: ${apiData.owner_info.first_name}`;
            }
            
            // آپدیت title صفحه
            document.title = `${apiData.name} | منوی دیجیتال`;
        }

        // تابع برای تبدیل داده‌های API به فرمت مورد نیاز
        function transformAPIData(apiData) {
            categories = [];
            menuItems = [];
            
            // پردازش دسته‌بندی‌ها
            apiData.menu_categories.forEach(category => {
                categories.push({
                    id: category.id,
                    name: category.name,
                    type: `category-${category.id}`
                });
                
                // پردازش آیتم‌های هر دسته‌بندی
                category.menu_items.forEach(item => {
                    menuItems.push({
                        id: item.id,
                        name: item.name,
                        category: `category-${category.id}`,
                        categoryName: category.name,
                        price: parseFloat(item.price),
                        description: item.description || 'توضیحاتی برای این آیتم موجود نیست',
                        popular: Math.random() > 0.7, // مقدار تصادفی برای نمایش
                        image: item.image_path ? `http://135.125.238.202:7050${item.image_path}` : getDefaultImage(category.name),
                        ingredients: getRandomIngredients(),
                        isAvailable: item.is_available,
                        options: item.options
                    });
                });
            });
        }

        // تابع برای ایجاد تب‌های داینامیک
        function createDynamicCategoryTabs() {
            // پاک کردن تب‌های موجود (به جز تب "همه")
            const allTab = categoriesContainer.querySelector('[data-category="all"]');
            categoriesContainer.innerHTML = '';
            categoriesContainer.appendChild(allTab);
            
            // ایجاد تب‌های جدید بر اساس دسته‌بندی‌های واقعی
            categories.forEach(category => {
                const tab = document.createElement('button');
                tab.className = 'category-btn px-8 py-3 rounded-xl flex items-center';
                tab.dataset.category = category.type;
                
                // آیکون بر اساس نوع دسته‌بندی
                let icon = 'fas fa-utensils';
                if (category.name.includes('نوشیدنی') || category.name.includes('دسته بندی 2')) {
                    icon = 'fas fa-mug-hot';
                } else if (category.name.includes('دسر') || category.name.includes('دسته بندی 3')) {
                    icon = 'fas fa-ice-cream';
                } else if (category.name.includes('صبحانه')) {
                    icon = 'fas fa-sun';
                }
                
                tab.innerHTML = `
                    <i class="${icon} ml-2"></i>
                    ${category.name}
                `;
                
                categoriesContainer.appendChild(tab);
            });
        }

        // تابع برای دریافت تصویر پیش‌فرض بر اساس دسته‌بندی
        function getDefaultImage(categoryName) {
            const defaultImages = {
                'نوشیدنی': 'https://images.unsplash.com/photo-1517701550927-30cf4ba1dba5?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                'دسر': 'https://images.unsplash.com/photo-1571115177098-24ec42ed204d?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                'غذای اصلی': 'https://images.unsplash.com/photo-1603360946369-dc9bb6258143?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                'صبحانه': 'https://images.unsplash.com/photo-1558584724-0e4d32ca55a4?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'
            };
            
            for (const [key, image] of Object.entries(defaultImages)) {
                if (categoryName.includes(key)) {
                    return image;
                }
            }
            
            return 'https://images.unsplash.com/photo-1558030006-450675393462?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80';
        }

        // تابع برای تولید مواد تشکیل‌دهنده تصادفی
        function getRandomIngredients() {
            const allIngredients = [
                "اسپرسو", "شیر تازه", "پودر کاکائو", "دانه قهوه عربیکا", "شیر بخار داده شده",
                "شیر وانیلی", "یخ", "نعنا تازه", "لیمو", "شکر قهوه‌ای", "سودا", "انبه",
                "پاپایا", "آناناس", "موز", "تخم مرغ", "سوسیس", "قارچ", "لوبیا", "نان تست",
                "گوجه", "فلفل دلمه‌ای", "پنکیک", "عسل", "توت فرنگی", "بلوبری", "خامه",
                "گوشت آنتری کات", "سیب زمینی", "سبزیجات", "پاستا", "خامه", "پنیر پارمزان",
                "کاهو رومی", "نان کروتون", "سس سزار", "پنیر خامه‌ای", "بیسکویت", "ماسکارپونه",
                "بیسکویت لیدی فینگر", "قهوه", "شکلات بلژیکی", "بستنی وانیلی"
            ];
            
            const count = Math.floor(Math.random() * 3) + 2; // 2-4 ماده
            const shuffled = allIngredients.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // تابع نمایش منو
        function displayMenu(items) {
            menuContainer.innerHTML = '';
            
            if (items.length === 0) {
                noItemsMessage.classList.remove('hidden');
                return;
            }
            
            noItemsMessage.classList.add('hidden');
            
            items.forEach((item, index) => {
                const menuItem = document.createElement('div');
                menuItem.className = `menu-item glass-card rounded-xl overflow-hidden fade-in ${!item.isAvailable ? 'opacity-60' : ''}`;
                menuItem.style.animationDelay = `${index * 0.1}s`;
                menuItem.dataset.id = item.id;
                menuItem.dataset.category = item.category;
                
                let popularBadge = '';
                if (item.popular) {
                    popularBadge = `
                        <div class="popular-badge absolute top-4 left-4 bg-gradient-to-r from-amber-500 to-pink-600 text-white px-4 py-1 rounded-full text-sm font-bold z-10">
                            <i class="fas fa-crown mr-1"></i> ویژه
                        </div>
                    `;
                }
                
                let unavailableOverlay = '';
                if (!item.isAvailable) {
                    unavailableOverlay = `
                        <div class="absolute inset-0 bg-black/60 flex items-center justify-center z-20">
                            <span class="bg-slate-800 text-white px-4 py-2 rounded-full font-bold">ناموجود</span>
                        </div>
                    `;
                }
                
                let ingredients = '';
                if (item.ingredients) {
                    ingredients = `
                        <div class="mt-4 pt-4 border-t border-white/10 light-mode:border-gray-200">
                            <h4 class="text-sm font-semibold text-amber-500 mb-2">مواد تشکیل‌دهنده:</h4>
                            <div class="flex flex-wrap gap-2">
                                ${item.ingredients.map(ing => `
                                    <span class="text-xs bg-black/20 light-mode:bg-white/70 px-2 py-1 rounded-full backdrop-blur-sm">
                                        ${ing}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                menuItem.innerHTML = `
                    <div class="relative h-64 overflow-hidden">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover ${!item.isAvailable ? 'grayscale' : ''}">
                        ${popularBadge}
                        ${unavailableOverlay}
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                            <h3 class="text-xl font-bold text-white">${item.name}</h3>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <p class="text-gray-300 light-mode:text-gray-600 text-sm leading-relaxed">${item.description}</p>
                            <span class="price-tag text-lg font-bold px-4 py-1 rounded-r-full -mr-5 -mt-5">${item.price.toLocaleString()} تومان</span>
                        </div>
                        ${ingredients}
                        <button class="add-to-cart w-full mt-6 py-3 text-white rounded-lg flex items-center justify-center space-x-2 space-x-reverse font-medium ${!item.isAvailable ? 'bg-gray-400 cursor-not-allowed' : ''}" 
                                ${!item.isAvailable ? 'disabled' : ''}>
                            <i class="fas fa-plus"></i>
                            <span>${!item.isAvailable ? 'ناموجود' : 'افزودن به سبد'}</span>
                        </button>
                    </div>
                `;
                
                menuContainer.appendChild(menuItem);
            });
        }

        // تابع نمایش سبد خرید
        function renderCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartBadge = document.getElementById('cart-badge');
            const cartTotal = document.getElementById('cart-total');
            
            // به‌روزرسانی تعداد آیتم‌ها
            cartBadge.textContent = cart.reduce((total, item) => total + item.quantity, 0);
            
            // محاسبه جمع کل
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotal.textContent = total.toLocaleString() + ' تومان';
            
            // اگر سبد خرید خالی است
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-basket"></i>
                        <p>سبد خرید شما خالی است</p>
                    </div>
                `;
                return;
            }
            
            // نمایش آیتم‌های سبد خرید
            cartItemsContainer.innerHTML = cart.map(item => `
                <div class="cart-item" data-id="${item.id}">
                    <div class="cart-item-img">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price.toLocaleString()} تومان</div>
                        <div class="cart-item-actions">
                            <div class="remove-item" onclick="removeFromCart(${item.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                            <div class="quantity-control">
                                <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                                <input type="text" class="quantity-input" value="${item.quantity}" readonly>
                                <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // افزودن به سبد خرید
        function addToCart(itemId) {
            const item = menuItems.find(item => item.id === itemId);
            
            if (!item || !item.isAvailable) return;
            
            // بررسی وجود آیتم در سبد خرید
            const existingItem = cart.find(cartItem => cartItem.id === itemId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...item,
                    quantity: 1
                });
            }
            
            renderCart();
            
            // افکت موفقیت‌آمیز
            Toastify({
                text: `${item.name} به سبد خرید اضافه شد`,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "left",
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                stopOnFocus: true,
            }).showToast();
        }
        
        // حذف از سبد خرید
        function removeFromCart(itemId) {
            cart = cart.filter(item => item.id !== itemId);
            renderCart();
        }
        
        // به‌روزرسانی تعداد آیتم
        function updateQuantity(itemId, change) {
            const item = cart.find(item => item.id === itemId);
            
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity < 1) {
                removeFromCart(itemId);
            } else {
                renderCart();
            }
        }
        
        // تسویه حساب
        function checkout() {
            if (cart.length === 0) {
                Toastify({
                    text: "سبد خرید شما خالی است",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "left",
                    backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
                    stopOnFocus: true,
                }).showToast();
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            Swal.fire({
                title: 'تسویه حساب',
                html: `مبلغ قابل پرداخت: <b>${total.toLocaleString()} تومان</b><br><br>لطفاً روش پرداخت را انتخاب کنید`,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'پرداخت آنلاین',
                cancelButtonText: 'پرداخت در محل',
                showDenyButton: true,
                denyButtonText: 'انصراف',
                customClass: {
                    confirmButton: 'bg-gradient-to-r from-amber-500 to-amber-600',
                    cancelButton: 'bg-gradient-to-r from-gray-500 to-gray-600',
                    denyButton: 'bg-gradient-to-r from-red-500 to-red-600'
                },
                buttonsStyling: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // پرداخت آنلاین
                    Swal.fire(
                        'پرداخت آنلاین',
                        'به صفحه پرداخت هدایت می‌شوید...',
                        'info'
                    );
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    // پرداخت در محل
                    Swal.fire(
                        'سفارش ثبت شد',
                        `سفارش شما با موفقیت ثبت شد و به مبلغ ${total.toLocaleString()} تومان آماده ارسال است.`,
                        'success'
                    );
                    cart = [];
                    renderCart();
                }
            });
        }

        // فیلتر بر اساس دسته‌بندی
        function filterByCategory(category) {
            const categoryBtns = document.querySelectorAll('.category-btn');
            categoryBtns.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            if (category === 'all') {
                displayMenu(menuItems);
            } else {
                const filteredItems = menuItems.filter(item => item.category === category);
                displayMenu(filteredItems);
            }
        }

        // جستجو در منو
        function searchMenu(query) {
            const clearBtn = document.getElementById('clear-search');
            if (query.length > 0) {
                clearBtn.style.opacity = '1';
                clearBtn.style.pointerEvents = 'auto';
            } else {
                clearBtn.style.opacity = '0';
                clearBtn.style.pointerEvents = 'none';
            }
            
            const filteredItems = menuItems.filter(item => 
                item.name.includes(query) || 
                item.description.includes(query) ||
                (item.ingredients && item.ingredients.some(ing => ing.includes(query)))
            );
            displayMenu(filteredItems);
        }

        // تغییر تم
        function toggleDarkMode() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('lightMode', document.body.classList.contains('light-mode'));
            
            const darkIcon = document.querySelector('.dark-mode-icon');
            const lightIcon = document.querySelector('.light-mode-icon');
            
            if (document.body.classList.contains('light-mode')) {
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            } else {
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            }
        }

        // نمایش خطا
        function showError(message) {
            loadingSection.innerHTML = `
                <div class="text-center py-10 text-red-500">
                    <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                    <p class="text-xl mb-4">${message}</p>
                    <button onclick="location.reload()" class="mt-4 bg-amber-500 text-white px-6 py-3 rounded-full hover:bg-amber-600 transition text-lg">
                        بارگذاری مجدد
                    </button>
                </div>
            `;
        }

        // رویدادهای صفحه
        document.addEventListener('DOMContentLoaded', () => {
            if (menuId) {
                loadFullMenu();
            } else {
                showError('شناسه منو یافت نشد. لطفاً از طریق لینک صحیح وارد شوید.');
            }
            
            // رویدادهای دکمه‌های دسته‌بندی (delegated)
            document.getElementById('categories-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('category-btn') || e.target.closest('.category-btn')) {
                    const btn = e.target.classList.contains('category-btn') ? e.target : e.target.closest('.category-btn');
                    filterByCategory(btn.dataset.category);
                }
            });
            
            // رویداد جستجو
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                searchMenu(e.target.value);
            });
            
            // پاک کردن جستجو
            document.getElementById('clear-search').addEventListener('click', () => {
                searchInput.value = '';
                searchMenu('');
                searchInput.focus();
            });
            
            // رویداد تغییر تم
            document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);
            
            // بررسی تم ذخیره شده
            if (localStorage.getItem('lightMode') === 'true') {
                document.body.classList.add('light-mode');
                document.querySelector('.dark-mode-icon').classList.add('hidden');
                document.querySelector('.light-mode-icon').classList.remove('hidden');
            }
            
            // رویدادهای سبد خرید
            document.getElementById('cart-icon').addEventListener('click', () => {
                document.getElementById('cart-panel').classList.add('open');
            });
            
            document.getElementById('close-cart').addEventListener('click', () => {
                document.getElementById('cart-panel').classList.remove('open');
            });
            
            document.getElementById('checkout-btn').addEventListener('click', checkout);
            
            // شبیه سازی کلیک روی دکمه افزودن به سبد
            document.addEventListener('click', (e) => {
                if (e.target.closest('.add-to-cart')) {
                    const menuItem = e.target.closest('.menu-item');
                    const itemId = parseInt(menuItem.dataset.id);
                    const btn = e.target.closest('.add-to-cart');
                    
                    if (btn.disabled) return;
                    
                    // افکت افزودن به سبد
                    btn.innerHTML = '<i class="fas fa-check"></i> <span>افزوده شد</span>';
                    btn.classList.remove('from-amber-500', 'to-amber-600');
                    btn.classList.add('from-green-500', 'to-green-600');
                    
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-plus"></i> <span>افزودن به سبد</span>';
                        btn.classList.remove('from-green-500', 'to-green-600');
                        btn.classList.add('from-amber-500', 'to-amber-600');
                    }, 2000);
                    
                    // افزودن به سبد خرید
                    addToCart(itemId);
                }
            });
        });
    </script>
</body>
</html>